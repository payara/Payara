<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Bean Detail — CDI Dev Mode</title>

        <!-- Payara styles -->
        <link rel="stylesheet" href="../assets/css/common-dashboard.css">
        <link rel="stylesheet" href="../assets/css/payara-theme.css">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="../assets/js/app-selector.js"></script>
    </head>

    <body>
        <div class="page">

            <!-- ================= HEADER ================= -->
            <div class="top devconsole-header">
                <div>
                    <h2 class="devconsole-title" id="beanTitle">Bean: —</h2>
                    <div id="beanScope" class="muted small"></div>
                    <div id="className" class="muted small" style="margin-top:4px"></div>

                    <div class="bean-meta mt-2">
                        <div class="meta-row">
                            <strong>Qualifiers:</strong>
                            <div class="chips" id="qualifiers"></div>
                        </div>
                        <div class="meta-row">
                            <strong>Stereotypes:</strong>
                            <div class="chips" id="stereotypes"></div>
                        </div>
                        <div class="meta-row">
                            <strong>Types:</strong>
                            <span id="typesInline" class="small muted"></span>
                        </div>
                    </div>

                    <!-- ===== TOOLBAR ===== -->
                    <div class="graph-toolbar">
                        <div id="info" class="graph-hint">
                            Click a node to see details
                        </div>

                        <div class="graph-controls">
                            <button id="fit" class="btn btn-outline-primary" title="Fit graph">
                                <i class="bi bi-arrows-fullscreen"></i>
                            </button>
                            <button id="center" class="btn btn-outline-secondary" title="Center root bean">
                                <i class="bi bi-crosshair"></i>
                            </button>
                            <button id="download" class="btn btn-outline-success" title="Download PNG">
                                <i class="bi bi-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= GRAPH ================= -->
            <div class="graph-canvas">
                <svg id="svg"></svg>
            </div>
        </div>

        <!-- ================= METADATA ================= -->
        <script>
            const base = '../cdi/beans/';
            const qs = p => new URL(location.href).searchParams.get(p);

            function renderChips(id, items) {
                const el = document.getElementById(id);
                el.innerHTML = '';
                (items || []).forEach(v => {
                    const d = document.createElement('div');
                    d.className = 'chip';
                    d.textContent = v;
                    el.appendChild(d);
                });
            }

            (async () => {
                const bean = qs('bean') || (location.pathname.match(/beans\/(.*)$/) || [])[1];
                if (!bean)
                    return;

                const name = decodeURIComponent(bean);
                document.getElementById('beanTitle').textContent = name;

                const r = await fetch(DevConsoleApp.api(base + encodeURIComponent(name)));
                const d = await r.json();

                document.getElementById('beanScope').textContent = d.scope || 'Unknown scope';
                document.getElementById('className').textContent = d.className || '';

                renderChips('qualifiers', d.qualifiers || []);
                renderChips('stereotypes', d.stereotypes?.length ? d.stereotypes : ['(none)']);
                document.getElementById('typesInline').textContent =
                        d.types?.length ? d.types.join(', ') : '(none)';
            })();
        </script>

        <!-- ================= GRAPH JS ================= -->
        <script>
            const bean = qs('bean') || (location.pathname.match(/beans\/(.*)$/) || [])[1];
            const endpoint = '../cdi/bean-graph/' + decodeURIComponent(bean);

            fetch(DevConsoleApp.api(endpoint))
                    .then(r => r.json())
                    .then(full => {
                        const rootId = endpoint.split('/').pop();
                        const nodes = {}, links = [], seen = new Set();

                        function walk(id) {
                            if (seen.has(id))
                                return;
                            seen.add(id);
                            const b = full.nodes[id];
                            if (!b)
                                return;

                            nodes[id] = {
                                id,
                                description: b.description,
                                type: id === rootId ? 'bean' : 'dep',
                                circular: b.circular === true
                            };

                            (b.dependencies || []).forEach(x => {
                                const depId = typeof x === 'string' ? x : x.beanId;
                                links.push({source: id, target: depId});
                                walk(depId);
                            });
                        }

                        walk(rootId);
                        render({nodes: Object.values(nodes), links});
                    });

            function render(graph) {
                const canvas = document.querySelector('.graph-canvas');
                const w = canvas.clientWidth;
                const h = canvas.clientHeight;

                const MARGIN = 140;

                const zoom = d3.zoom().on('zoom', e => g.attr('transform', e.transform));
                const svg = d3.select('#svg')
                        .attr('viewBox', `${-MARGIN} ${-MARGIN} ${w + MARGIN * 2} ${h + MARGIN * 2}`)
                        .call(zoom);

                const g = svg.append('g');

                const sim = d3.forceSimulation(graph.nodes)
                        .force('link', d3.forceLink(graph.links)
                                .id(d => d.id)
                                .distance(180)
                                .strength(0.9)
                                )
                        .force('charge', d3.forceManyBody().strength(-1100))
                        .force('center', d3.forceCenter(w / 2, h / 2))
                        .force('collision', d3.forceCollide().radius(d =>
                            Math.max(d.w || 80, d.h || 24) / 2 + 14
                        ));

                const link = g.append('g').selectAll('line')
                        .data(graph.links)
                        .join('line')
                        .attr('class', 'link');

                const node = g.append('g').selectAll('g')
                        .data(graph.nodes)
                        .join('g')
                        .attr('class', 'node')
                        .call(d3.drag()
                                .on('start', e => !e.active && sim.alphaTarget(0.3).restart())
                                .on('drag', (e, d) => {
                                    d.fx = e.x;
                                    d.fy = e.y;
                                })
                                .on('end', () => sim.alphaTarget(0)));

                node.append('rect')
                        .attr('rx', d => d.type === 'bean' ? 10 : 8)
                        .attr('ry', d => d.type === 'bean' ? 10 : 8)
                        .attr('class', d =>
                            d.circular ? 'circular' :
                                    d.type === 'bean' ? 'bean' : 'dep'
                        );

                node.append('text')
                        .attr('text-anchor', 'middle')
                        .attr('dominant-baseline', 'middle')
                        .text(d => d.id.split('.').slice(-2).join('.'));

                node.each(function (d) {
                    const b = this.getBBox();
                    d.w = b.width + 28;
                    d.h = b.height + 18;
                    d3.select(this).select('rect')
                            .attr('x', -d.w / 2)
                            .attr('y', -d.h / 2)
                            .attr('width', d.w)
                            .attr('height', d.h);
                });

                node.on('click', (e, d) => {
                    d3.selectAll('.node').classed('selected', false);
                    d3.select(e.currentTarget).classed('selected', true);
                    document.getElementById('info').innerText =
                            `${d.id}\n\n${d.description || 'Dependency'}`;
                });

                sim.on('tick', () => {
                    link
                            .attr('x1', d => d.source.x)
                            .attr('y1', d => d.source.y)
                            .attr('x2', d => d.target.x)
                            .attr('y2', d => d.target.y);
                    node.attr('transform', d => `translate(${d.x},${d.y})`);
                });

                /* Auto-fit on load */
                setTimeout(() => document.getElementById('fit').click(), 300);

                document.getElementById('fit').onclick = () => {
                    const b = g.node().getBBox();
                    const s = Math.min(
                            (w - 240) / b.width,
                            (h - 240) / b.height
                            );
                    svg.transition().call(
                            zoom.transform,
                            d3.zoomIdentity
                            .translate(
                                    w / 2 - (b.x + b.width / 2) * s,
                                    h / 2 - (b.y + b.height / 2) * s
                                    )
                            .scale(s)
                            );
                };

                document.getElementById('center').onclick = () => {
                    const r = graph.nodes.find(n => n.type === 'bean');
                    if (!r)
                        return;
                    svg.transition().call(
                            zoom.transform,
                            d3.zoomIdentity.translate(w / 2 - r.x, h / 2 - r.y)
                            );
                };
            }
        </script>
    </body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
    <!-- 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"</script>
     -->

    <style>
    .canvas-holder {
	    position: absolute;
	    top: 250px;
	    left: 20px;
	    width: 600px;
	    border: 2px solid #ccc;
    }
    body { margin: 2em; }
    </style>
</head>
<body>

<h1>Monitoring Console (Alpha)</h1>

<input type="checkbox" id="zero" checked="checked" /> Begin at Zero</br>
<input type="checkbox" id="labels" checked="checked" /> Automatic Labels</br>
<input type="checkbox" id="curves" checked="checked" /> Use Bezier Curves </br>
<input type="checkbox" id="animations" checked="checked" /> Use Animations</br>
<input type="checkbox" id="rotation" checked="checked" /> Label X-Axis at 90Â°</br>

Series: <select id="options"></select>
<div class="canvas-holder">
    <canvas id="myChart" width="2" height="1"></canvas>
</div>

<script>
var lastNs;
var options = $("#options");
$.getJSON("api/series/", function(response) {
    $.each(response, function() {
    	var key = this.replace(/ /g, ',');
        var ns =  this.substring(3, this.indexOf(' '));
        var $option = $("<option />").val(key).text(this.substring(this.indexOf(' ')));
        if (ns == lastNs) {
        	options.find('optgroup').last().append($option);
        } else {
        	var group = $('<optgroup/>').attr('label', ns);
        	group.append($option);
        	options.append(group);
        }
        lastNs = ns;
    });
});


var refresher;
var chart;

$("#zero").on('change', function() {
	if (chart) {
		chart.options.scales.yAxes[0].ticks.beginAtZero = this.checked;
		chart.update();
	}
});

$("#labels").on('change', function() {
    if (chart) {
        chart.options.scales.xAxes[0].ticks.source = this.checked ? 'auto' : 'data';
        chart.update();
    }
});
$("#curves").on('change', function() {
	if (chart) {
		chart.options.elements.line.tension = this.checked ? 0.4 : 0;
		chart.update();
	}
});
$('#animations').on('change', function() {
	if (chart) {
		var time = this.checked ? 1000 : 0;
		chart.options.animation.duration = time;
		chart.options.responsiveAnimationDuration = time;
		chart.update();
	}
});
$("#rotation").on('change', function() {
    if (chart) {
    	var rotation = this.checked ? 90 : undefined;
    	chart.options.scales.xAxes[0].ticks.minRotation = rotation;
    	chart.options.scales.xAxes[0].ticks.maxRotation = rotation;
        chart.update();
    }
});

function customTimeLables(value, index, values) {
	if (values.length == 0 || index == 0)
		return value;
	var span = values[values.length -1].value - values[0].value;
	if (span < 120000) { // less then two minite
		var lastMinute = new Date(values[index-1].value).getMinutes();
		return new Date(values[index].value).getMinutes() != lastMinute ? value : ''+new Date(values[index].value).getSeconds();
	}
	return value;
}

options.on('change', function() {
	var selectedSeries = this.value;
	var label = this.textContent;
	if (refresher) {
		clearInterval(refresher);
	}
    var ctx = $('#myChart');
    if (chart) {
    	chart.destroy();
    }
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{ 
            	data: [],
                backgroundColor: [ 'rgba(153, 102, 255, 0.2)' ],
                borderColor: [ 'rgba(153, 102, 255, 1)' ],
                borderWidth: 1
            },
            {
            	data: [],
            	fill:  false,
            	borderColor: [ 'rgba(75, 192, 192, 1)' ],
            	borderWidth: 1,
            	pointRadius: 0
            }
            ],
        },
        options: {
            scales: {
                xAxes: [{
                    type: 'time',
                    time: {
                    	minUnit: 'second',
                    	round: 'second',
                    },
                    ticks: {
                    	callback: customTimeLables,
                        minRotation: 90,
                    	maxRotation: 90,
                    }
                }],
                yAxes: [{
                    display: true,
                    ticks: {
                        beginAtZero: $('#zero')[0].checked,
                        precision:0, // no decimal places in labels
                    },
                }],
            }
        }
    });
	
	refresher = setInterval(updateSeries, 1000, selectedSeries);
});

function updateSeries(series) {
	$.getJSON('api/series/' + series + '/statistics', function(stats) {
		var points = stats.points;
		var data = [];
		if (points) {
			data = new Array(points.length / 2);
		    for (var i = 0; i < data.length; i++) {
		        data[i] = { t: new Date(points[i*2]), y: points[i*2+1] };
		    }
		}
		var avg = stats.observedSum / stats.observedValues;
		var avgData = [{t:data[0].t, y:avg}, {t:data[data.length-1].t, y:avg}];
	    chart.data.datasets[0].data = data;
	    chart.data.datasets[0].label = series;
        chart.data.datasets[1].data = avgData;
        chart.data.datasets[1].label = 'avg';	
	    chart.update(0);
	});
} 
</script>

</body>
</html>
